# pts-fasm-bootstrap: bootstrap the fasm assembler on Linux i386

pts-fasm-boostrap bootstraps the fasm assembler on Linux i386, i.e. it
reproduces a recent `fasm` Linux i386 executable program bit-by-bit
identical to the official distribution from its source (and also from the
sources of earlier fasm versions), using only fasm sources (both old and
recent versions), but no precompiled executable programs of earlier
fasm versions.

pts-fasm-bootstrap was inspired by [bootstrapping FASM by rugxulo,
2018-02-20](https://board.flatassembler.net/topic.php?t=20431).

How to run the new, simple bootstrap:

* On a Linux x86 system (i386 or amd64), check out the Git repository, and
  run `perl -x boostrap1.pl`. The output file is `fasm1'.

* Then run `perl -x bootstrap2.pl'. The output file is `fasm-re-1.73.32`,
  which is identical to the file `fasm-golden-1.73.32`, also identical to
  the program file in the [official fasm-1.73.32
  package](https://flatassembler.net/fasm-1.73.32.tgz).

* The output file is executable on a Linux x86 system (i386 or amd64), and
  it's statically linked (i.e. independent of the Linux distribution and the
  libc).

## Bootstrap chain of the simple bootstrap

There are two steps:

1. ([bootstrap1.pl](bootstrap1.pl))
   Build an old (1.20 or 1.37) fasm executable program from its source by
   converting the old fasm source to [NASM](https://nasm.us/) syntax with a
   few dozen Perl regexp substitutions, and compiling the result with NASM.

2. ([bootstrap2.pl](bootstrap2.pl))
   With the fasm executable program built in step 1, compile a patched
   version of a recent fasm (1.73.32). Then with that executable program,
   recompile the recent fasm from its unpatched source.

Step 1 is possible because the source of old fasm is similar enough to NASM
syntax so that it can be converted to NASM syntax using a few dozen regexp
substitutions. NASM syntax and features have also changed over time, but
only a backward-compatible subset of it is used here, and thus anything
between NASM 0.95 (released on 1997-07-27) and 2.16.03 (released on
2024-04-17) works.

Currently the fasm sources of version 1.20 (released on 2001-11-17) and 1.37
(released on 2002-06-12) are supported in step 1. fasm 1.37 was the first
version supporting Linux i386 hosts (i.e. the `SOURCE/LINUX` directory). For
fasm 1.20, bootstrap1.pl contains about 450 lines of assembly code
containing Linux i386 host support.

Step 2 is possible becase the source of a recent fasm is still so simple
that it can be compiled with new, old and even ancient fasm versions, after
applying a few simple patches. These patches are:

* The *format elf executable 3*, *entry ...* and *segment ..* directives
  used for ELF-32 executable generation are replaced with manual building of
  the ELF-32 header files with *db*, *dw* and *dd* directives.
* The *salc* and *pushd* instructions and the *align* directive missing
  from old fasm are polyfilled using simple macros.

To make it easy to reproduce, the Perl scripts bootstrap1.pl and
bootstrap2.pl were written so that they work with old and new versions of
Perl running on Linux i386 or Linux amd64. In particular, they work with
Perl as old as 5.004_04 (released on 1997-10-15). Thus this way it is
possible to bootstrap a recent fasm using only technology available on
2001-11-17 (Linux i386, Perl >=5.004_04, *unzip*, NASM >=0.95 and fasm 1.20
sources).

The following source files are used:

* *fasm.fasm* generated by bootstrap1.pl by concatenating the old fasm
  * source to a single file and applying patches.
* *fasm.nasm* generated by bootstrap2.pl by converting *fasm.fasm* to NASM
  syntax.
* *fasm3.fasm* generated by bootstrap2.pl by concatenating the recent fasm
  source to a single file and applying patches.
* *fasm4.nasm* generated by bootstrap2.pl by concatenating the recent fasm
  source to a single file, without applying patches.

The detailed bootstrap chain:

* *fasm.nasm* is compiled by NASM to Linux i386 ELF-32 executable program
  *fasm0*.
* *fasm.fasm* is compiled by *fasm0* to *fasm1*.
* *fasm.fasm* is compiled by *fasm1* to *fasm2*.
* *fasm1* and *fasm2* are compared to each other (they must be bitwise
  identical), *fasm1* is the output of step 1.
* *fasm3.nasm* is compiled by *fasm1* to *fasm4*.
* *fasm4.nasm* is compiled by *fasm4* to *fasm5*.
* *fasm4.nasm* is compiled by *fasm5* to *fasm6*.
* *fasm5* and *fasm6* are compared to each other (they must be bitwise
  identical), *fasm5* is the output of step 2, and also the final output.
* *fasm6* is compared to the *fasm/fasm* Linux i386 ELF-32 executable
  program in the offical fasm release (they must be bitwise identical).

Alternatively, step 1 can be replaced by objtaining a fasm-compatible
assembler (and using it in step 2). For example, *fbsasm* (see below)
works, and it can be used by running step 2 as `perl -x boostrap2.pl
--fasm=./fbsasm`. fasm executable programs (old and new) in the official
binary release of fasm also work.

It would be a challenge to bootstrap a recent fasm using Perl >=5.004_04
only. This would require implementing *unzip* and *zcat* and writing a
specialized i386 assembler (supporting the subset of FASM syntax used in
recent fasm) in pure Perl 5.004_04. All of these are hard but doable. They
are left as an exercise to the reader.

## The old, versatile bootstrap

How to run the old, versatile bootstrap:

* On a Linux x86 system (i386 or amd64), check out the Git repository, and
  run `./bootstrap_fasm.sh`.

* The output file is `fasm-re-1.73.32`, which is identical to the file
  `fasm-golden-1.73.32`, also identical to the program file in the [official
  fasm-1.73.32 package](https://flatassembler.net/fasm-1.73.32.tgz).

* The output file is executable on a Linux x86 system (i386 or amd64), and
  it's statically linked (i.e. independent of the Linux distribution and the
  libc).

## Bootstrap chain of the versatile bootstrap

Involved fasm versions:

* fasm 1.20, released on 2001-11-17
* fasm 1.73.32, released on 2023-12-04

Both of these bootstrap chains are done by `./bootstrap_fasm.sh`:

* bootstrap assembler --> patched fasm 1.73.32 --> original fasm 1.73.32

* bootstrap assembler --> patched fasm 1.20 --> patched fasm 1.73.32 --> original fasm 1.73.32

## The bootstrap assembler used in the versatile bootstrap

The bootstrap assembler is a simple, non-optimizing assembler targeting i386
(32-bit x86 only), and supports a subset of fasm syntax, and supports only a
subset of the i386 (32-bit x86) instructions. Its only goal is to compile
any of fasm 1.20, fasm 1.30 or fasm 1.73.32. Currently it is able to compile
a lightly patched source of all of them. `bootstrap_fasm.sh` does the
necessary patching.

Initially the bootstrap assembler was able to compile fasm 1.20 and fasm
1.30, but then it was discovered that it can also compile a lightly
patched fasm 1.73.32.

The bootstrap assembler has multiple (equivalent) implementations:

* The implementation for the oldest assembler is `fbsasm.mas`, which works
  with MASM 5.00 (1987-07-31), see the details below.
* NASM: already implemented as `fbsasm.nasm`, use it with
  `./bootstrap_nasm.sh nasm`. It is a reimplementation of a subset of fasm
  1.30 (for Linux i386) in NASM 0.95 (1997-07-27) or later. It has been
  tested with 0.98.39 extensively. It was created by
  concatenating source files from fasm 1.30 and fasm 1.37 (Linux-specific
  `fasm.asm` and `system.inc`), and manually converting it to NASM syntax
  (mostly doing some manual changes and then many regexp substitutions).
* Yasm: already implemented as `fbsasm.nasm`, use it with
  `./bootstrap_nasm.sh nasm=yasm`. The NASM source works without changes.
  Versions 1.2.0 (2011-10-31) and 1.3.0 (2014-09-11) are known to work.
  Maybe older versions work as well.
* fasm: already implemented as `fbsasm.fasm`, use it with
  `./bootstrap_fasm.sh fasm`. It needs at least fasm 1.20 (2001-11-17)
  to compile.
* GNU as(1) (+ GNU ld(1)): already implemented as `fbsasm.s`, use it with
  `./bootstrap_fasm.sh as`. It is autogenerated by `fbsasm.nasm` using the
  bundled `nasm2as.pl` Perl script. It works with various versions of GNU
  Binutils, tested with 2.7 (released on 1996-07-15), 2.9.1 (released on
  1998-05-01, part of Debian 2.1 slink), 2.9.5, 2.22 and 2.30.
* TASM (Turbo Assembler) + folink2 (custom linker): already implemented as
  `fbsasm.tas` (TASM ideal mode),
  use it with `./bootstrap_fasm.sh tasm`. It works with TASM
  1.01 (1989), 2.0 (1990), 4.1 (1996, the latest Turbo Assembler which works
  on a DOS 8086 without a DOS extender) and 5.3 (2000-01-30, probably the
  last release of TASM). The custom linker folink2 is also included and is
  built from source by TASM.
* LZASM (Lazy Assembler) + folink2 (custom linker): already implemented as
  `fbsasm.tas` (TASM ideal mode),
  use it with `./bootstrap_fasm.sh lzasm`. It works with LZASM
  0.56 (2007-10-04, last release) and possibly earlier. The custom linker
  folink2 is also included and is built from source by LZASM.
* MASM (Microsoft Macro Assembler) + WLINK: already implemented as
  `fbsasm.was`, currently `bootstrap_fasm.sh` doesn't support it. It works
  with MASM 5.00 (1987-07-31) or later, TASM 3.0 (1991-11-11) or later, WASM
  10.5 (1995-07-11) or later, JWasm 2.11a (2013-10-19) and maybe earlier,
  ASMC 2.34.49 (2024-030-26) and later and maybe earlier.
* as86 (part of dev86): already implemented as
  `fbsasm.as86`, use it with `./bootstrap_fasm.sh as86`. It works with as86
  0.0.7 (1996-09-03) and possibly earlier, but not 0.0.5.
* A386 (by Eric Isaacson): already implemented
  as `fbsasm.8`, use it with `./bootstrap_fasm.sh a386`. It works with the
  A386 4.05 (2000-01-13) on a DOS 8086 (maybe needs an i386 processor).
* [vasm](http://sun.hasenbraten.de/vasm/) (by Volker Barthelmann): already
  implemented as `fbsasm.vasm`, use it with `./bootstrap_fasm.sh vasm`. It
  works with vasm 1.9a (2022-10-02) and possibly earlier.
* [mw386as](https://github.com/pts/mw386as)
  (port of the Mark Williams 80386 assembler, originally 1993-08-02, part of
  Coherent) + link3coff.pl (custom linker),
  use it with `./bootstrap_fasm.sh mw`. It works with the
  1993-08-02 version rebuilt from source, but the code generated by 1992-11-11
  version seems to be broken. The custom linker is also included, and it's a
  Perl script. A Linux i386 executable of the Perl interpreter is also
  included.
* The AT&T Unix System V Release 3 (SVR3) assembler (see [Linux i386
  port](https://github.com/pts/pts-svr3as-linux)) + link3coff.pl (custom
  linker), use it with `./bootstrap_fasm.sh --svr3=...`. All 3 versions
  (1987-10-28, 1988-05-27, 1989-10-03) work. The custom linker is also
  included, and it's a Perl script. A Linux i386 executable of the Perl
  interpreter is also included.
* The SunOS 4.0.1 assembler (see [Linux i386
  port](https://github.com/pts/pts-svr3as-linux)) + link3coff.pl (custom
  linker), use it with `./bootstrap_fasm.sh --svr3=...`. The version
  released on 1988-11-16 works. The custom linker is also
  included, and it's a Perl script. A Linux i386 executable of the Perl
  interpreter is also included.
* The AT&T Unix System V Release 4 (SVR4) assembler, built from source
  (released on 1993-01-16)
  port](https://github.com/pts/pts-svr3as-linux)) + GNU ld(1), use it with
  `./bootstrap_fasm.sh --svr4=...`. This assembler has more code generation
  bugs than its predecessor, the SVR3 assembler. These bugs have been worked
  around for the purposes of pts-fasm-bootstrap.

It is a future plan to have the bootstrap assembler implemented in additional
programming languages, targeting Linux i386:

* MASM (Microsoft Macro Assembler) + folink3 (custom linker)
* JWasm: with a bit of luck, the MASM port will work. JWasm can emit binary
  files with the `-bin' flag, the linker is not
* WASM (Watcom Assembler) + folink3 (custom linker): with a bit of luck, the
  MASM port will work; also maybe WLINK will work in raw binary mode
* [ASMC](https://github.com/nidud/asmc): ASMC is a fork of JWasm, so with a
  bit of luck, the MASM port will work
* C89 (ANSI C): it should work with GCC on Debian slink (released on
  1999-03-09), released before 2001-01-01, before fasm 1.20; how far can we
  go to the past? 1999? 1996?
* Perl 5.004_04 (1997-10-15). A slow but simple assembler which can compile
  fbsasm.fasm. Maybe later it will be able to compile FASM-1.73.32 and
  fbsasm.nasm.
* [Solaris x86
  Assembler](https://docs.oracle.com/cd/E19120-01/open.solaris/817-5477/eqbui/index.html),
  part of OpenSolaris.
* POASM from Pelle's C.
* [HLA](https://en.wikipedia.org/wiki/High_Level_Assembly) with its built-in
  linker.
* [GoAsm.exe](http://www.godevtool.com/) + GoLink.exe.
* [ASM32](https://www.intelligentfirm.com/cpl32.html):
  it supports flat .bin output in use32 mode.
* [XAssembler](https://web.archive.org/web/20070823101949/http://xasm.webpark.pl:80/xasm/en_download.htm).
